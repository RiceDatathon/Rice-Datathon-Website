{"ast":null,"code":"\"use strict\";\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.initScriptLoader = initScriptLoader;\nexports.default = void 0;\n\nvar _react = require(\"react\");\n\nvar _headManagerContext = require(\"../shared/lib/head-manager-context\");\n\nvar _headManager = require(\"./head-manager\");\n\nvar _requestIdleCallback = require(\"./request-idle-callback\");\n\nfunction _defineProperty(obj, key, value) {\n  if (key in obj) {\n    Object.defineProperty(obj, key, {\n      value: value,\n      enumerable: true,\n      configurable: true,\n      writable: true\n    });\n  } else {\n    obj[key] = value;\n  }\n\n  return obj;\n}\n\nfunction _objectSpread(target) {\n  for (var i = 1; i < arguments.length; i++) {\n    var source = arguments[i] != null ? arguments[i] : {};\n    var ownKeys = Object.keys(source);\n\n    if (typeof Object.getOwnPropertySymbols === \"function\") {\n      ownKeys = ownKeys.concat(Object.getOwnPropertySymbols(source).filter(function (sym) {\n        return Object.getOwnPropertyDescriptor(source, sym).enumerable;\n      }));\n    }\n\n    ownKeys.forEach(function (key) {\n      _defineProperty(target, key, source[key]);\n    });\n  }\n\n  return target;\n}\n\nfunction _objectWithoutProperties(source, excluded) {\n  if (source == null) return {};\n\n  var target = _objectWithoutPropertiesLoose(source, excluded);\n\n  var key, i;\n\n  if (Object.getOwnPropertySymbols) {\n    var sourceSymbolKeys = Object.getOwnPropertySymbols(source);\n\n    for (i = 0; i < sourceSymbolKeys.length; i++) {\n      key = sourceSymbolKeys[i];\n      if (excluded.indexOf(key) >= 0) continue;\n      if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue;\n      target[key] = source[key];\n    }\n  }\n\n  return target;\n}\n\nfunction _objectWithoutPropertiesLoose(source, excluded) {\n  if (source == null) return {};\n  var target = {};\n  var sourceKeys = Object.keys(source);\n  var key, i;\n\n  for (i = 0; i < sourceKeys.length; i++) {\n    key = sourceKeys[i];\n    if (excluded.indexOf(key) >= 0) continue;\n    target[key] = source[key];\n  }\n\n  return target;\n}\n\nconst ScriptCache = new Map();\nconst LoadCache = new Set();\nconst ignoreProps = ['onLoad', 'dangerouslySetInnerHTML', 'children', 'onError', 'strategy'];\n\nconst loadScript = props => {\n  const {\n    src,\n    id,\n    onLoad = () => {},\n    dangerouslySetInnerHTML,\n    children = '',\n    strategy = 'afterInteractive',\n    onError\n  } = props;\n  const cacheKey = id || src; // Script has already loaded\n\n  if (cacheKey && LoadCache.has(cacheKey)) {\n    return;\n  } // Contents of this script are already loading/loaded\n\n\n  if (ScriptCache.has(src)) {\n    LoadCache.add(cacheKey); // Execute onLoad since the script loading has begun\n\n    ScriptCache.get(src).then(onLoad, onError);\n    return;\n  }\n\n  const el = document.createElement('script');\n  const loadPromise = new Promise((resolve, reject) => {\n    el.addEventListener('load', function (e) {\n      resolve();\n\n      if (onLoad) {\n        onLoad.call(this, e);\n      }\n    });\n    el.addEventListener('error', function (e) {\n      reject(e);\n    });\n  }).catch(function (e) {\n    if (onError) {\n      onError(e);\n    }\n  });\n\n  if (src) {\n    ScriptCache.set(src, loadPromise);\n  }\n\n  LoadCache.add(cacheKey);\n\n  if (dangerouslySetInnerHTML) {\n    el.innerHTML = dangerouslySetInnerHTML.__html || '';\n  } else if (children) {\n    el.textContent = typeof children === 'string' ? children : Array.isArray(children) ? children.join('') : '';\n  } else if (src) {\n    el.src = src;\n  }\n\n  for (const [k, value] of Object.entries(props)) {\n    if (value === undefined || ignoreProps.includes(k)) {\n      continue;\n    }\n\n    const attr = _headManager.DOMAttributeNames[k] || k.toLowerCase();\n    el.setAttribute(attr, value);\n  }\n\n  el.setAttribute('data-nscript', strategy);\n  document.body.appendChild(el);\n};\n\nfunction handleClientScriptLoad(props) {\n  const {\n    strategy = 'afterInteractive'\n  } = props;\n\n  if (strategy === 'afterInteractive') {\n    loadScript(props);\n  } else if (strategy === 'lazyOnload') {\n    window.addEventListener('load', () => {\n      (0, _requestIdleCallback).requestIdleCallback(() => loadScript(props));\n    });\n  }\n}\n\nfunction loadLazyScript(props) {\n  if (document.readyState === 'complete') {\n    (0, _requestIdleCallback).requestIdleCallback(() => loadScript(props));\n  } else {\n    window.addEventListener('load', () => {\n      (0, _requestIdleCallback).requestIdleCallback(() => loadScript(props));\n    });\n  }\n}\n\nfunction initScriptLoader(scriptLoaderItems) {\n  scriptLoaderItems.forEach(handleClientScriptLoad);\n}\n\nfunction Script(props) {\n  const {\n    src = '',\n    onLoad = () => {},\n    dangerouslySetInnerHTML,\n    strategy = 'afterInteractive',\n    onError\n  } = props,\n        restProps = _objectWithoutProperties(props, [\"src\", \"onLoad\", \"dangerouslySetInnerHTML\", \"strategy\", \"onError\"]); // Context is available only during SSR\n\n\n  const {\n    updateScripts,\n    scripts,\n    getIsSsr\n  } = (0, _react).useContext(_headManagerContext.HeadManagerContext);\n  (0, _react).useEffect(() => {\n    if (strategy === 'afterInteractive') {\n      loadScript(props);\n    } else if (strategy === 'lazyOnload') {\n      loadLazyScript(props);\n    }\n  }, [props, strategy]);\n\n  if (strategy === 'beforeInteractive') {\n    if (updateScripts) {\n      scripts.beforeInteractive = (scripts.beforeInteractive || []).concat([_objectSpread({\n        src,\n        onLoad,\n        onError\n      }, restProps)]);\n      updateScripts(scripts);\n    } else if (getIsSsr && getIsSsr()) {\n      // Script has already loaded during SSR\n      LoadCache.add(restProps.id || src);\n    } else if (getIsSsr && !getIsSsr()) {\n      loadScript(props);\n    }\n  }\n\n  return null;\n}\n\nvar _default = Script;\nexports.default = _default;","map":{"version":3,"sources":["../../client/script.tsx"],"names":[],"mappings":"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","sourcesContent":["import React, { useEffect, useContext } from 'react'\nimport { ScriptHTMLAttributes } from 'react'\nimport { HeadManagerContext } from '../shared/lib/head-manager-context'\nimport { DOMAttributeNames } from './head-manager'\nimport { requestIdleCallback } from './request-idle-callback'\n\nconst ScriptCache = new Map()\nconst LoadCache = new Set()\n\nexport interface ScriptProps extends ScriptHTMLAttributes<HTMLScriptElement> {\n  strategy?: 'afterInteractive' | 'lazyOnload' | 'beforeInteractive'\n  id?: string\n  onLoad?: (e: any) => void\n  onError?: (e: any) => void\n  children?: React.ReactNode\n}\n\n/**\n * @deprecated Use `ScriptProps` instead.\n */\nexport type Props = ScriptProps\n\nconst ignoreProps = [\n  'onLoad',\n  'dangerouslySetInnerHTML',\n  'children',\n  'onError',\n  'strategy',\n]\n\nconst loadScript = (props: ScriptProps): void => {\n  const {\n    src,\n    id,\n    onLoad = () => {},\n    dangerouslySetInnerHTML,\n    children = '',\n    strategy = 'afterInteractive',\n    onError,\n  } = props\n\n  const cacheKey = id || src\n\n  // Script has already loaded\n  if (cacheKey && LoadCache.has(cacheKey)) {\n    return\n  }\n\n  // Contents of this script are already loading/loaded\n  if (ScriptCache.has(src)) {\n    LoadCache.add(cacheKey)\n    // Execute onLoad since the script loading has begun\n    ScriptCache.get(src).then(onLoad, onError)\n    return\n  }\n\n  const el = document.createElement('script')\n\n  const loadPromise = new Promise<void>((resolve, reject) => {\n    el.addEventListener('load', function (e) {\n      resolve()\n      if (onLoad) {\n        onLoad.call(this, e)\n      }\n    })\n    el.addEventListener('error', function (e) {\n      reject(e)\n    })\n  }).catch(function (e) {\n    if (onError) {\n      onError(e)\n    }\n  })\n\n  if (src) {\n    ScriptCache.set(src, loadPromise)\n  }\n  LoadCache.add(cacheKey)\n\n  if (dangerouslySetInnerHTML) {\n    el.innerHTML = dangerouslySetInnerHTML.__html || ''\n  } else if (children) {\n    el.textContent =\n      typeof children === 'string'\n        ? children\n        : Array.isArray(children)\n        ? children.join('')\n        : ''\n  } else if (src) {\n    el.src = src\n  }\n\n  for (const [k, value] of Object.entries(props)) {\n    if (value === undefined || ignoreProps.includes(k)) {\n      continue\n    }\n\n    const attr = DOMAttributeNames[k] || k.toLowerCase()\n    el.setAttribute(attr, value)\n  }\n\n  el.setAttribute('data-nscript', strategy)\n\n  document.body.appendChild(el)\n}\n\nfunction handleClientScriptLoad(props: ScriptProps) {\n  const { strategy = 'afterInteractive' } = props\n  if (strategy === 'afterInteractive') {\n    loadScript(props)\n  } else if (strategy === 'lazyOnload') {\n    window.addEventListener('load', () => {\n      requestIdleCallback(() => loadScript(props))\n    })\n  }\n}\n\nfunction loadLazyScript(props: ScriptProps) {\n  if (document.readyState === 'complete') {\n    requestIdleCallback(() => loadScript(props))\n  } else {\n    window.addEventListener('load', () => {\n      requestIdleCallback(() => loadScript(props))\n    })\n  }\n}\n\nexport function initScriptLoader(scriptLoaderItems: ScriptProps[]) {\n  scriptLoaderItems.forEach(handleClientScriptLoad)\n}\n\nfunction Script(props: ScriptProps): JSX.Element | null {\n  const {\n    src = '',\n    onLoad = () => {},\n    dangerouslySetInnerHTML,\n    strategy = 'afterInteractive',\n    onError,\n    ...restProps\n  } = props\n\n  // Context is available only during SSR\n  const { updateScripts, scripts, getIsSsr } = useContext(HeadManagerContext)\n\n  useEffect(() => {\n    if (strategy === 'afterInteractive') {\n      loadScript(props)\n    } else if (strategy === 'lazyOnload') {\n      loadLazyScript(props)\n    }\n  }, [props, strategy])\n\n  if (strategy === 'beforeInteractive') {\n    if (updateScripts) {\n      scripts.beforeInteractive = (scripts.beforeInteractive || []).concat([\n        {\n          src,\n          onLoad,\n          onError,\n          ...restProps,\n        },\n      ])\n      updateScripts(scripts)\n    } else if (getIsSsr && getIsSsr()) {\n      // Script has already loaded during SSR\n      LoadCache.add(restProps.id || src)\n    } else if (getIsSsr && !getIsSsr()) {\n      loadScript(props)\n    }\n  }\n\n  return null\n}\n\nexport default Script\n"]},"metadata":{},"sourceType":"script"}